---
title: "树莓派入坑"
description: ""
date: 2017-06-14T20:08:28+08:00
author: "uncoder"
tags: ["raspberry","nginx","docker","ssh","vnc"]
categories: ["服务器相关"]
slug: ""
---

# 安装系统

- 下载[地址](https://www.raspberrypi.org/downloads/)
- 刷入系统[etcher](https://etcher.io/)
备注：需要外置键盘、鼠标、hdmi显示器
<!--more-->

# 设置U盘启动

由于sd卡，在断电时容易文件损毁，所以使用U盘启动。

1. 确保sd卡正常启动，新增启动项配置
```
echo program_usb_boot_mode=1 | sudo tee -a /boot/config.txt
```
2. 检查设置是否成功（输出信息应该为 17:3020000a或者大于他）
```
vcgencmd otp_dump | grep 17
```
3. 把出SD卡，插入U盘(和SD卡一样先刷入系统)即可

# 升级系统

`sudo apt-get update && sudo apt-get upgrade`

# 修改分辨率

`/boot/config.txt`

# ssh登陆(开启)

SSH登录：`ssh pi@树莓派ip地址`，默认密码为`raspberry`

# vnc连接(开启)

下载[地址](https://www.realvnc.com/download/viewer/)

# 安装输入法

1.`sudo apt-get install fcitx fcitx-googlepinyin`
2.重启一下，然后点击`树莓图标->Preferences->Fctix Configuration`
3.点击左下角的`+`图标，然后去掉 `Only Show Current Language`，在下面输入`google`直接搜索出来`google pinyin`输入法

# 安装ohmyzsh
```
sudo apt install zsh
sh -c "$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
```
# docker

1. 在线[脚本]安装(https://docs.docker.com/install/linux/docker-ce/debian/)

```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
```

2. pi加入`docker`用户组

```bash
sudo usermod -aG docker pi
```

3. 基础镜像源

dockerHub官方维护的`arm32v7`镜像[列表](https://hub.docker.com/u/arm32v7)

```shell
这里我们下载一个resin.io维护的一个镜像
docker pull resin/rpi-raspbian
```

4. 安装docker-compose

1.使用`pip`安装
```bash
# Install required packages
apt update
apt install -y python python-pip

# Install Docker Compose from pip
pip install docker-compose
cd /home/pi/.local/bin
cp docker-compose /usr/local/bin/docker-compose
```

2.源码编译[安装](https://qiita.com/katsusuke/items/beec05e1afcd67ebd3dc)
这种方式容易崩溃，勿试。
```bash
git clone https://github.com/docker/compose.git
cd compose
sudo docker build -t docker-compose:armhf -f Dockerfile.armhf .
sudo docker run --rm --entrypoint="script/build/linux-entrypoint" -v $(pwd)/dist:/code/dist -
sudo cp dist/docker-compose-Linux-armv7l /usr/local/bin/docker-compose
docker-compose --version
```


5. portainer可视化管理

```bash
docker run -d -p 9999:9000 -v "/var/run/docker.sock:/var/run/docker.sock" portainer/portainer
```

6. 跑个容器玩玩，挂载树莓派的/home/pi/www到容器的/www目录

```bash
sudo docker run -it -p 80:80 -v /home/pi/www:/www --name mynginx -d resin/rpi-raspbian /bin/bash
```

# 安装nginx

1. 由于默认源安装的版本较低，源码编译[安装](https://github.com/MatthewVance/nginx-build)

2. docker[安装](https://hub.docker.com/r/arm32v7/nginx)

# 安装yarn, pm2

1. yarn默认安装位置`.config/yarn/global`
2. 若pm2命令没有找到，新建软连接

```bash
sudo ln -s /home/pi/.config/yarn/global/node_modules/pm2/bin/pm2 /usr/local/bin
```

# 一键安装nextCloud

这里我们使用docker进行[安装](https://hub.docker.com/r/arm32v7/nextcloud)

```yml
# 创建docker-compose.yml, 填入
version: '2'
volumes:
  nextcloud:
  db:
services:
  db:
    image: hypriot/rpi-mysql
    restart: always
    volumes:
      - /home/pi/myfolder/nextcloud/db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=
      - MYSQL_PASSWORD=
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
  app:
    image: arm32v7/nextcloud
    ports:
      - 8080:80
    links:
      - db
    volumes:
      - /home/pi/myfolder/nextcloud/nextcloud:/var/www/html
    restart: always
```

登陆时，数据库地址填`db`即可

# 搭建NFS服务

1. [安装](https://packages.debian.org/stretch/rpcbind)

```bash
# 正常安装
# sudo apt install nfs-utils，这个树莓派不需要，这是一个包，里面包含两个[软件](https://packages.debian.org/search?arch=armhf&searchon=sourcenames&keywords=nfs-utils)
sudo apt install nfs-kernel-server
sudo apt install rpcbind
```

2. 配置

编辑/新建`/etc/exports`,输入

```bash
# insecure确保端口号大于1024也可以
/tmp *(rw,insecure)
```

3. 开启服务

```bash
sudo systemctl start rpcbind
sudo systemctl start nfs-kernel-server
```

nfs会开启3个服务:

1. portmapper:  做端口映射的(默认使用111端口)
2. mountd:  管理NFS的文件系统(默认使用20048端口，可在/etc/services中查看到，没有可手动加入 )

```bash
mountd 20048/udp
mountd 20048/tcp
```

3. nfs:  管理客户端登录(默认使用2049端口)  


4. 开启frp端口转发

编辑frpc.ini

```bash
[range:tcp_port]
type = tcp
local_ip = 127.0.0.1
local_port = 111,2049,20048
remote_port = 111,2049,20048

[range:udp_port]
type = udp
local_ip = 127.0.0.1
local_port = 111,2049,20048
remote_port = 111,2049,20048
```

5. 完毕

# aria2下载服务

1. apt安装，版本较旧，可选官方源码[安装指南](https://github.com/aria2/aria2)
2. docker安装[alpine-arm](https://hub.docker.com/r/easypi/alpine-arm/)
为啥用这个，因为这个apk包里面有最新版本

```bash
apk update
apk add --no-cache --update aria2
```

```bash
/etc/apt/sources.list.d
```