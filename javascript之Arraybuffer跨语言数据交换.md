---
title: "javascriptä¹‹Arraybufferè·¨è¯­è¨€æ•°æ®äº¤æ¢"
date: 2020-8-13T16:01:25+08:00
description: ""
author: "uncoder-fe"
tags: ["Arraybuffer"]
categories: ["javascript"]
slug: ""
---


> If you can't explain it simply, you don't understand it well enough.
> Albert Einstein

# æ¦‚å¿µ
å‰ç«¯é¢†åŸŸæ¥çœ‹ï¼ŒArrayBuffer å¯¹è±¡ç”¨æ¥è¡¨ç¤ºé€šç”¨çš„ã€å›ºå®šé•¿åº¦çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºã€‚
å…¶ä»–è¯­è¨€ä¸­ç§°ä¸ºbyte arrayï¼Œå®ƒæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚

ä¸¾ä¸ªæ —å­ï¼šå¸¸è§çš„æ–‡ä»¶ä¸‹è½½/å›¾åƒä¸‹è½½ï¼Œè¿™é‡Œä½¿ç”¨å·¦ä¸Šè§’çš„iconå½“ä½œèµ„æºåœ°å€ï¼ˆåç¼€webpçš„ï¼ŒæŒºå…ˆè¿›çš„ï¼‰
```
fetch('https://s3.pstatp.com/ee/feishu_website/static/img/logo-zh.648d6d020e.webp', { method: 'get' })
.then(response=>response.arrayBuffer())// å¯é€‰blob()ï¼Œè¿™é‡Œåªåšå¯¹bufferç±»å‹çš„è®¾å®šï¼Œä¹Ÿæœ‰å…¶ä»–ç±»å‹
.then(arrybuffer=>{ console.log(arrybuffer) });
```
æµè§ˆå™¨æ§åˆ¶å°ç›´æ¥æ‹·è´ä»¥ä¸Šä»£ç ï¼Œå¹¶å›è½¦æ‰§è¡Œï¼Œç»“æœå¦‚ä¸‹ã€‚


èªæ˜çš„ä½ å·²ç»å‘ç°äº†å¥‡æ€ªçš„äº‹ï¼ŒInt8Array / Int16Array / Uint8Arrayè¿™äº›ä¸œè¥¿ï¼Œå…¶å®æ˜¯ä¸€æ ·çš„(ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„)ï¼ŒåŒä¸€ä»½bufferçš„ä¸åŒç¼–ç æ ¼å¼çš„ç±»æ•°ç»„(TypedArray)ï¼Œå¯ä»¥çœ‹åˆ°æ¯ç§ç±»å‹åé¢çš„é•¿åº¦ï¼ˆå­—èŠ‚ä¸ªæ•°ï¼‰ï¼Œ3462 = 1731*2ã€‚è¿˜å¯ä»¥çœ‹åˆ°arraybufferçš„é•¿åº¦å’ŒInt8Arrayçš„é•¿åº¦ä¸€æ ·ï¼Œéƒ½æ˜¯3462ï¼Œè¿™ä¸ªç‚¹å¯ä»¥æ³¨æ„ä¸€ä¸‹ã€‚
## typedArray

ä¸€ä¸ªç±»å‹åŒ–æ•°ç»„ï¼ˆTypedArrayï¼‰å¯¹è±¡æè¿°äº†ä¸€ä¸ªåº•å±‚çš„äºŒè¿›åˆ¶æ•°æ®ç¼“å†²åŒºï¼ˆbinary data bufferï¼‰çš„ä¸€ä¸ªç±»æ•°ç»„è§†å›¾ï¼ˆviewï¼‰ã€‚

## 16è¿›åˆ¶æ•°æ®
16è¿›åˆ¶æ•°æ®(ç®€å†™ä¸ºhexï¼Œåœ¨æ•°å­¦ä¸­æ˜¯ä¸€ç§é€¢16è¿›1çš„è¿›ä½åˆ¶)ã€‚ä¸¾ä¸ªä¾‹å­, çº¢è‰²çš„é˜´å½±æ˜¯åè¿›åˆ¶ 238,9,63 ï¼Œæˆ–è€…rgb(238, 9, 63)ï¼Œå¯ä»¥ç¼–æˆ #ee093fã€‚

åšè¿‡åŠ å¯†æ¯”å¦‚(AES)çš„åŒå­¦åº”è¯¥çŸ¥é“base64ä¸hexæ˜¯å¸¸ç”¨çš„æ ¼å¼ï¼Œæ€è€ƒï¼Œä¸ºå•¥ç”¨è¿™ç§æ–¹å¼å‘¢ï¼Ÿ

# ç”Ÿæˆarraybuffer
ä½ ä¸èƒ½ç›´æ¥æ“ä½œ ArrayBuffer çš„å†…å®¹ï¼Œè€Œæ˜¯è¦é€šè¿‡ç±»å‹æ•°ç»„å¯¹è±¡ï¼ˆTypedArrayï¼‰æˆ– DataView å¯¹è±¡æ¥æ“ä½œï¼Œå®ƒä»¬ä¼šå°†ç¼“å†²åŒºä¸­çš„æ•°æ®è¡¨ç¤ºä¸ºç‰¹å®šçš„æ ¼å¼ï¼Œå¹¶é€šè¿‡è¿™äº›æ ¼å¼æ¥è¯»å†™ç¼“å†²åŒºçš„å†…å®¹ã€‚
åˆ©ç”¨æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªArrayBufferå¯¹è±¡

```js
const arrybuffer = new ArrayBuffer(length);
length: è¦åˆ›å»ºçš„ ArrayBuffer çš„å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼ˆByteï¼‰ã€‚
arrybuffer: ä¸€ä¸ªæŒ‡å®šå¤§å°çš„ ArrayBuffer å¯¹è±¡ï¼Œå…¶å†…å®¹è¢«åˆå§‹åŒ–ä¸º0ã€‚
```

## å­—èŠ‚
æ²¡æœ‰è·³åŠ¨ï¼Œè¿™ä¸ªè®¡ç®—æœºæœ¯è¯­æ˜¯ä¸ªæ—§è¯æ±‡ï¼Œä¸‹é¢æ°æ‰¯ä¸€ä¸‹ã€‚

### å­—èŠ‚ï¼ˆè‹±è¯­ï¼šByteï¼‰ï¼Œé€šå¸¸ç”¨ä½œè®¡ç®—æœºä¿¡æ¯è®¡é‡å•ä½ï¼Œä¸åˆ†æ•°æ®ç±»å‹ã€‚ä»å†å²çš„è§‚ç‚¹ä¸Šï¼Œâ€œå­—èŠ‚â€è¡¨ç¤ºç”¨äºç¼–ç å•ä¸ªå­—ç¬¦æ‰€éœ€è¦çš„æ¯”ç‰¹æ•°é‡ã€‚ä»Šæ—¥äº‹å®æ ‡å‡†ä»¥8æ¯”ç‰¹ä½œä¸ºä¸€å­—èŠ‚ï¼Œå› 8ä¸ºäºŒè¿›åˆ¶æ•´æ•°ï¼ˆæ¯ä¸ªæ•°å­—ç§°ä¸ºä¸€ä¸ªæ¯”ç‰¹ï¼ˆäºŒè¿›åˆ¶ä½ï¼‰æˆ–æ¯”ç‰¹ï¼ˆBitï¼ŒBinary digit çš„ç¼©å†™ï¼‰ï¼‰ã€‚ç¼©å†™ä¸ºB

å¯ä»¥çœ‹åˆ°ï¼Œè¿›åˆ¶è¶Šå¤§è¶ŠçŸ­ï¼Œä¼ è¾“æ•°æ®è¶Šå°‘ã€‚ä¸€ä¸ªå­—èŠ‚æœ€å¤§å€¼ï¼ˆ8ä½ï¼‰çš„åè¿›åˆ¶è¡¨ç¤ºä¸º255ï¼Œæ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„ä¸€ä¸ªæ•°å­—ã€‚
### æ¯”ç‰¹
ï¼ˆè‹±è¯­ï¼šBitï¼Œäº¦ç§°äºŒè¿›åˆ¶ä½ï¼‰æŒ‡äºŒè¿›åˆ¶ä¸­çš„ä¸€ä½ï¼Œæ˜¯ä¿¡æ¯çš„æœ€å°å•ä½ã€‚ç¼©å†™ä¸ºb
## Unicode
ï¼ˆä¸­æ–‡ï¼šä¸‡å›½ç ã€å›½é™…ç ã€ç»Ÿä¸€ç ã€å•ä¸€ç ï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦é¢†åŸŸé‡Œçš„ä¸€é¡¹ä¸šç•Œæ ‡å‡†ã€‚å®ƒå¯¹ä¸–ç•Œä¸Šå¤§éƒ¨åˆ†çš„æ–‡å­—ç³»ç»Ÿè¿›è¡Œäº†æ•´ç†ã€ç¼–ç ï¼Œä½¿å¾—ç”µè„‘å¯ä»¥ç”¨æ›´ä¸ºç®€å•çš„æ–¹å¼æ¥å‘ˆç°å’Œå¤„ç†æ–‡å­—ã€‚å½“å‰æœ€æ–°çš„ç‰ˆæœ¬ä¸º2019å¹´5æœˆå…¬å¸ƒçš„12.1.0ï¼Œå·²ç»æ”¶å½•è¶…è¿‡13ä¸‡ä¸ªå­—ç¬¦ã€‚Unicodeæ¶µç›–çš„æ•°æ®é™¤äº†è§†è§‰ä¸Šçš„å­—å½¢ã€ç¼–ç æ–¹æ³•ã€æ ‡å‡†çš„å­—ç¬¦ç¼–ç å¤–ï¼Œè¿˜åŒ…å«äº†å­—ç¬¦ç‰¹æ€§ï¼Œå¦‚å¤§å°å†™å­—æ¯ã€‚

åœ¨æ–‡å­—å¤„ç†æ–¹é¢ï¼Œç»Ÿä¸€ç ä¸ºæ¯ä¸€ä¸ªå­—ç¬¦è€Œéå­—å½¢å®šä¹‰å”¯ä¸€çš„ä»£ç ï¼ˆå³ä¸€ä¸ªæ•´æ•°ï¼Œåè¿›åˆ¶ï¼‰ã€‚

åœ¨è¡¨ç¤ºä¸€ä¸ª Unicode çš„å­—ç¬¦æ—¶ï¼Œé€šå¸¸ä¼šç”¨â€œU+â€ç„¶åç´§æ¥ç€ä¸€ç»„åå…­è¿›åˆ¶çš„æ•°å­—æ¥è¡¨ç¤ºè¿™ä¸€ä¸ªå­—ç¬¦ã€‚

æ¯”å¦‚æ —å­ï¼š

```js
const str = 'ä¸­';
const i = str.charCodeAt(); 
// äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œ100111000101101
// åè¿›åˆ¶è¡¨ç¤ºï¼Œ20013
// UTF-16 code unitsï¼Œ4e2d
String.fromCharCode(i);  // "ä¸­"
```
Unicode çš„å®ç°æ–¹å¼ç§°ä¸º Unicodeè½¬æ¢æ ¼å¼ï¼ˆUnicode Transformation Formatï¼Œç®€ç§°ä¸º UTFï¼‰

### UTF-8
UTF-8ï¼ˆ8-bit Unicode Transformation Formatï¼‰æ˜¯ä¸€ç§é’ˆå¯¹Unicodeçš„å¯å˜é•¿åº¦å­—ç¬¦ç¼–ç ï¼Œä¹Ÿæ˜¯ä¸€ç§å‰ç¼€ç ã€‚å®ƒå¯ä»¥ç”¨ä¸€è‡³å››ä¸ªå­—èŠ‚å¯¹Unicodeå­—ç¬¦é›†ä¸­çš„æ‰€æœ‰æœ‰æ•ˆç¼–ç ç‚¹è¿›è¡Œç¼–ç ï¼Œå±äºUnicodeæ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œæœ€åˆç”±è‚¯Â·æ±¤æ™®é€Šå’Œç½—å¸ƒÂ·æ´¾å…‹æå‡ºã€‚

```js
00000000 00000000 00000000 00000000  // æ­¤è¡Œæ²¡æœ‰æ„ä¹‰ï¼Œæ–¹ä¾¿è§‚çœ‹å¯¹æ¯”
// 4e2dï¼Œåœ¨ç¬¬ä¸‰ä¸ªèŒƒå›´ï¼Œéœ€è¦ç”¨ä¸‰ä¸ªå­—èŠ‚ï¼ˆ3 * 8ï¼‰24ä½è¡¨ç¤º
100 1110 0010 1101  // äºŒè¿›åˆ¶
1110xxxx 10xxxxxx 10xxxxxx // æ›¿æ¢ä¸Šé¢çš„xï¼Œä½è¯´ä¸å¤Ÿxå˜ä¸º0
11100100 10111000 10101101 //è½¬æ¢ä¸ºUTF-8åˆ†ç»„
e4       b8       ad  //è½¬æ¢ä¸ºUTF-8åˆ†ç»„ï¼Œ16è¿›åˆ¶è¡¨ç¤º  
```
 èµ·ç‚¹/ç»ˆç‚¹ï¼Œ16è¿›åˆ¶è¡¨ç¤º
 
### UTF-16
è®¡ç®—å¤ªå¤æ‚äº†ï¼Œä¸è¯´äº†

## ä»base64åˆ›å»ºä¸€ä¸ªArryBufferå¯¹è±¡
é¦–å…ˆæˆ‘ä»¬è·å–ä¸€ä¸ªbase64çš„å­—ç¬¦ä¸²ï¼Œå¸¸è§„æ“ä½œï¼Œè§è¯å¥‡è¿¹ã€‚

```js
const str = 'ä¸­';
const barse64Str = window.btoa(str); //å•Šå“¦ï¼Œæµè§ˆå™¨æŠ¥é”™äº† The string to be encoded contains characters outside of the Latin1 range.
æŠ¥é”™äº†ï¼Œå¾ˆå°´å°¬ï¼Œæœ‰äººçŸ¥é“ä¸ºä»€ä¹ˆå˜›ï¼Ÿ
```
### base64
Base64 æ˜¯ä¸€ç»„ç›¸ä¼¼çš„äºŒè¿›åˆ¶åˆ°æ–‡æœ¬ï¼ˆbinary-to-textï¼‰çš„ç¼–ç è§„åˆ™ï¼Œä½¿å¾—äºŒè¿›åˆ¶æ•°æ®åœ¨è§£é‡Šæˆ radix-64 çš„è¡¨ç°å½¢å¼åèƒ½å¤Ÿç”¨ ASCII å­—ç¬¦ä¸²çš„æ ¼å¼è¡¨ç¤ºå‡ºæ¥ã€‚

### ASCII 
American Standard Code for Information Interchangeæ˜¯åŸºäºæ‹‰ä¸å­—æ¯çš„ä¸€å¥—ç”µè„‘ç¼–ç ç³»ç»Ÿã€‚å±€é™åœ¨äºåªèƒ½æ˜¾ç¤º26ä¸ªåŸºæœ¬æ‹‰ä¸å­—æ¯ã€é˜¿æ‹‰ä¼¯æ•°å­—å’Œè‹±å¼æ ‡ç‚¹ç¬¦å·ï¼Œå› æ­¤åªèƒ½ç”¨äºæ˜¾ç¤ºç°ä»£ç¾å›½è‹±è¯­ã€‚
é—®é¢˜åŸå› ï¼Œè¿™æ ·å¤„ç†ã€‚
ç”±äº DOMString æˆ–è€… String æ˜¯16ä½ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¦‚æœæœ‰å­—ç¬¦è¶…å‡ºäº†8ä½ASCIIç¼–ç çš„å­—ç¬¦èŒƒå›´æ—¶ï¼Œåœ¨å¤§å¤šæ•°çš„æµè§ˆå™¨ä¸­å¯¹Unicodeå­—ç¬¦ä¸²è°ƒç”¨ window.btoa å°†ä¼šé€ æˆä¸€ä¸ª Character Out Of Range çš„å¼‚å¸¸ã€‚

æœ‰å¾ˆå¤šç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼šé«˜ä½è½¬ä½ä½
è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸‰ä¸ªæ–¹æ³•ï¼ŒåŸå› æ˜¯ä»£ç çŸ­ / å° / ä¾¿æºï¼Œä½ æ‡‚çš„ğŸ˜ˆ

```js
// ç¼–ç 
function btoaUTF16(sString) {
    // å…ˆå£°æ˜ä¸€ä¸ªæ— ç¬¦å·16ä½çš„ç±»æ•°ç»„ï¼Œå¯ç†è§£ä¸ºæ‰¿è½½å®¹å™¨
    const aUTF16CodeUnits = new Uint16Array(sString.length);
    // å®¹å™¨è£…å¡«æ¯ä¸ªå­—ç¬¦å¯¹åº”çš„ç´¢å¼•å€¼
    Array.prototype.forEach.call(aUTF16CodeUnits, function(el, idx, arr) {
       arr[idx] = sString.charCodeAt(idx);
    });
    // æ— ç¬¦å·16ä½ç±»æ•°ç»„ è½¬ä¸º æ— ç¬¦å·8ä½ç±»æ•°ç»„
    const array = new Uint8Array(aUTF16CodeUnits.buffer); // Uint8Array(6) [45, 78, 253, 86, 166, 104]
    const str = String.fromCharCode.apply(null, array); // é”™è¯¯çš„å­—ç¬¦ä¸²ï¼Œ-NÃ½VÂ¦h
    // è¿”å›base64å­—ç¬¦ä¸²
    return window.btoa(str);
}
const resultBase64 = btoaUTF16('ä¸­å›½æ¢¦'); // 'LU79VqZo'

// è§£ç 
function atobUTF16(sBase64) {
    // è§£ç base64
    const sBinaryString = window.atob(sBase64);  //-NÃ½VÂ¦h
    // åˆ›å»º8ä½ç±»æ•°ç»„ï¼Œå¯ç†è§£ä¸ºæ‰¿è½½å®¹å™¨
    const aBinaryView = new Uint8Array(sBinaryString.length); 
    // å®¹å™¨è£…å¡«æ¯ä¸ªå­—ç¬¦å¯¹åº”çš„ç´¢å¼•å€¼
    Array.prototype.forEach.call(aBinaryView, function(el, idx, arr) {
        arr[idx] = sBinaryString.charCodeAt(idx);
    });
    // Uint8Array(6) [45, 78, 253, 86, 166, 104]
    // æ­£ç¡®çš„å­—ç¬¦ä¸²
    return String.fromCharCode.apply(null, new Uint16Array(aBinaryView.buffer));
}
const result = atobUTF16('LU79VqZo'); // 'ä¸­å›½æ¢¦'
```

åˆ°æ­¤base64åˆ›å»ºarraybufferå·²ç»ç»“æŸäº†ï¼Œå•¥ï¼Œä½ æ²¡çœ‹æ˜ç™½ï¼Ÿçœ‹æ¥ä½ æ²¡æ³¨æ„å¬è®²å•Š.

## ä»å­—ç¬¦ä¸²åˆ›å»ºä¸€ä¸ªArrayBuffer

```js
const enc = new TextEncoder(); // always utf-8
const arry = enc.encode('ä¸­å›½æ¢¦');
console.log(arry);
const dnc = new TextDecoder();
console.log(dnc.decode(arry))
```

## ä»blobåˆ›å»ºä¸€ä¸ªArrayBuffer
ä½¿ç”¨å¼€å¤´æˆ‘ä»¬çš„æ —å­ï¼Œç›´æ¥å‘èµ·è¯·æ±‚

```js
fetch('https://s3.pstatp.com/ee/feishu_website/static/img/logo-zh.648d6d020e.webp', { method: 'get' })
.then(response => response.blob())
.then(blob => { console.log(blob) });
```
æ§åˆ¶å°æ‰§è¡Œï¼Œè¾“å…¥å¦‚ä¸‹

ä¸é”™ä¸é”™ï¼Œå·²ç»æœ‰blobå¯¹è±¡äº†ï¼Œä¸‹ä¸€æ­¥å°±éå¸¸ç®€å•äº†

```js
const buffer = await blob.arrayBuffer();
```

## æ€è€ƒï¼Œæ—¢ç„¶blobåˆ›å»ºbufferè¿™ä¹ˆç®€å•ï¼Œé‚£æˆ–è®¸å¯ä»¥åˆ©ç”¨ä¸€ä¸‹
åˆ›å»ºä¸€ä¸ªblobå¯¹è±¡ï¼Œç„¶åå¡å…¥ä¸€ä¸ªå­—ç¬¦ä¸²

```js
const blob = new Blob(['ä¸­å›½æ¢¦'], {type : 'plain/text'});
const buffer = await blob.arrayBuffer();
```
ä¼¼ä¹ï¼Œå¥½åƒï¼Œå¯ä»¥

# åè½¬arraybufferä¸ºæ•°æ®
## è½¬ string

```js
function ab2str(buf) {
  return String.fromCharCode.apply(null, new Uint16Array(buf));
}
```

## è½¬  blob  è½¬ object

```js
const blob = new Blob([arraybuffer||typedArray]);
const reader = new FileReader();
reader.readAsText(blob, 'utf-16');
reader.onload = function(e) {
    console.info(reader.result);
};
```

## è½¬  string

```js
new TextDecoder('utf-16').decode(typedArray)
```

# å¤‡æ³¨
è¡¨å•ä¸Šä¼ çš„æ—¶å€™ï¼Œæ¨èä½¿ç”¨typedArrayã€‚

